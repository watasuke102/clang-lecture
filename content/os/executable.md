---
title: "実行形式ファイルができるまで"
date: 2022-06-08T11:36:21+09:00
draft: true
---

## 前提知識

この章は、C 言語をある程度理解してから読んだほうが良いかもしれません。

- C 言語のファイル分割に関する知識
- ELF

## 導入

C 言語でプログラムを記述し、clang や gcc にそれを渡すことによって、実行形式ファイルを得ることが出来ます。それでは、clang や gcc は何をしてくれているのでしょうか？このページでは、コンパイラ及びリンカの働きを見ていきます。

## Transition phases

C 言語において、ソースコードが実行形式ファイルになるまでの流れを `Transition phases` と呼びます（仕様書 5.1.1.2）。大まかな流れでいうと、以下のような手順を踏みます：

1. マルチバイト文字・代替演算子の置き換え  
   ソースコードに含まれる文字を `source character set` と呼ばれる、基本的な英数字と記号に置き換えます。例えば、改行文字・マルチバイト文字・代替演算子などが置き換えられます。
2. バックスラッシュと改行が連続している部分を結合
   この書き方は微妙に分かりづらいですが、例えば、複数行に渡るマクロを書く際に文末にバックスラッシュを入れたりしますよね？これらが置き換えられます。さらに、以下のようなコードも置き換えられます。

```c
pr\
int\
f("Hello\n");
// after: printf(“Hello\n”);

```

3. プリプロセッサ用のトークンを生成
   例えば `#include` におけるヘッダ名など、プリプロセッサのためのトークンが生成されます。
4. プリプロセッサの実行
   先ほど生成したトークンをもとに、`#include` によるファイルの展開などが行われます。展開されたファイルに対してもここまで紹介してきた処理が行われます。
5. 文字および文字列のマッピング
   文字定数と文字列リテラル内の文字およびエスケープシーケンスが `execution character set` と呼ばれる文字セットに置き換えられます。
6. 文字列リテラルの連結
   C 言語において、2 つ以上の文字列リテラルを並べて書いた際、それらを 1 つの文字列リテラルとして連結して扱うことが出来ます。そのための処理がここで行われます。
7. コンパイルの実行
   いよいよコンパイルです。コンパイラはソースコードを読み、コンパイルを行います。
8. リンクの実行
   リンカは、コンパイル結果をもとに、各環境に適した実行形式ファイルを出力します。

この内、重要なのは最後の 2 つです。ここからは、この 2 つについて学んでいくことにします。

## コンパイラの役割とオブジェクトファイル

コンパイラは、前述の通りソースコードをコンパイルします。とても大まかに言うと、以下のような流れになります：

1. トークンの生成
2. アセンブリの生成

## リンカの役割
